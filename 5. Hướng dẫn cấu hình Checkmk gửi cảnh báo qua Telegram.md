# ğŸ“˜ HÆ°á»›ng dáº«n cáº¥u hÃ¬nh Checkmk gá»­i cáº£nh bÃ¡o qua Telegram

## 1. Chuáº©n bá»‹
- ÄÃ£ cÃ i Checkmk server vÃ  táº¡o site (vÃ­ dá»¥: `hpa`).  
- CÃ³ tÃ i khoáº£n Telegram.  
- Táº¡o **Bot Telegram** báº±ng BotFather.  
  - `/newbot` â†’ Ä‘áº·t tÃªn + username (pháº£i káº¿t thÃºc báº±ng `bot`).  
  - Nháº­n **API Token** (vÃ­ dá»¥: `8227933247:AAH8B2L2e_mPk0h4UEiuQhdlPrbN708IWiU`).  
- Chat riÃªng vá»›i bot, gÃµ `/start` Ä‘á»ƒ bot cÃ³ thá»ƒ nháº¯n láº¡i.  
- Láº¥y **Chat ID** báº±ng API:  
  ```bash
  https://api.telegram.org/bot<TOKEN>/getUpdates
  ```
  Káº¿t quáº£ JSON cho tháº¥y:
  ```json
  "chat": {
      "id": 5206335495,
      "type": "private"
  }
  ```
  â†’ Chat ID = `5206335495`.

---

## 2. Test nhanh vá»›i curl
```bash
TOKEN="8227933247:AAH8B2L2e_mPk0h4UEiuQhdlPrbN708IWiU"
CHAT_ID="5206335495"

curl -v -X POST "https://api.telegram.org/bot${TOKEN}/sendMessage" \
  -d chat_id="${CHAT_ID}"   --data-urlencode "text=Checkmk test OK âœ…"
```
âœ” Náº¿u nháº­n tin trong Telegram â†’ Token + Chat ID chuáº©n.

---

## 3. Táº¡o script notifier trong site Checkmk
Trong site user (vÃ­ dá»¥ `OMD[hpa]:~$`):

```bash
nano ~/local/share/check_mk/notifications/telegram
```

Ná»™i dung script:

```bash
#!/bin/bash
# Telegram notifier for Checkmk (private chat)

set -euo pipefail

TOKEN="8227933247:AAH8B2L2e_mPk0h4UEiuQhdlPrbN708IWiU"
CHAT_ID="5206335495"   # Chat riÃªng vá»›i user (Ä‘Ã£ /start bot)

TITLE="${NOTIFY_WHAT^^} ${NOTIFY_STATE} on ${NOTIFY_HOSTNAME}"
[ -n "${NOTIFY_SERVICEDESC:-}" ] && TITLE="Service ${NOTIFY_SERVICEDESC} ${NOTIFY_STATE} on ${NOTIFY_HOSTNAME}"

BODY=$'Time: '"${NOTIFY_DATE:-}"$'\nSite: '"${OMD_SITE:-}"$'\nHost: '"${NOTIFY_HOSTNAME:-}"$'\nIPv4: '"${NOTIFY_HOSTADDRESS:-}"$'\nService: '"${NOTIFY_SERVICEDESC:-}"$'\nSummary: '"${NOTIFY_SHORTINFO:-}"

curl -s -X POST "https://api.telegram.org/bot${TOKEN}/sendMessage" \
  -d chat_id="${CHAT_ID}" \
  --data-urlencode "text=${TITLE}\n${BODY}"

exit 0
```

Cáº¥p quyá»n thá»±c thi:
```bash
chmod +x ~/local/share/check_mk/notifications/telegram
```

---

## 4. Cáº¥u hÃ¬nh Notification Rule trong Checkmk
- VÃ o GUI â†’ **Setup â†’ Events â†’ Notifications â†’ Add rule**  
- **Notification Method (plug-in):** chá»n `telegram` (script vá»«a táº¡o)  
- **Recipient:** chá»n user nháº­n cáº£nh bÃ¡o (vd: `cmkadmin`)  
- Save â†’ **Activate Changes**

---

## 5. Kiá»ƒm tra hoáº¡t Ä‘á»™ng
- Trong GUI â†’ **Test notification** cho 1 host/service.  
- Má»Ÿ log site:
  ```bash
  tail -n 200 -f ~/var/log/notify.log
  ```
  âœ” Náº¿u tháº¥y:
  ```
  executing .../notifications/telegram
  Plugin exited with code 0
  ```
  â†’ ThÃ nh cÃ´ng.  
- Äá»“ng thá»i tin nháº¯n sáº½ tá»›i Telegram:
  ```
  SERVICE CRITICAL on Ubuntu01
  Time: 2025-09-11 10:22
  Site: hpa
  Host: Ubuntu01
  IPv4: 192.168.1.10
  Service: CPU load
  Summary: Load=12.0
  ```

---

## 6. LÆ°u Ã½
- Náº¿u gá»­i cho **group** â†’ Chat ID pháº£i cÃ³ dáº¡ng `-100xxxxxxxxxx`.  
- Náº¿u gá»­i cho user â†’ pháº£i /start bot trÆ°á»›c (báº¡n Ä‘Ã£ lÃ m).  
- CÃ³ thá»ƒ táº¡o nhiá»u script `telegram-noc`, `telegram-admin` vá»›i Chat ID khÃ¡c nhau Ä‘á»ƒ gá»­i tá»›i nhiá»u kÃªnh.  
- Äá»ƒ debug lá»—i, bá» `>/dev/null 2>&1` trong script Ä‘á»ƒ tháº¥y thÃ´ng bÃ¡o API.  

---

âœ… Sau khi hoÃ n thÃ nh, Checkmk sáº½ tá»± Ä‘á»™ng gá»­i cáº£nh bÃ¡o (DOWN, WARN, CRIT, RECOVERY) trá»±c tiáº¿p vá» Telegram cá»§a báº¡n.  
